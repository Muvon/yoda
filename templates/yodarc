#!/usr/bin/env bash
commit=$(git rev-parse HEAD 2>/dev/null || echo 'latest')
REVISION_TAG=$(git describe --exact-match "$commit" 2>/dev/null || true)
GIT_URL=$(git config --get remote.origin.url 2> /dev/null || true)
GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2> /dev/null || echo 'master')
SOURCE_PATH=$(pwd)
DOCKER_ROOT=$(cd "${BASH_SOURCE%/*}" && pwd)

export \
  YODA_VERSION="{{yoda_version}}" \
  REVISION=${REVISION:-$commit} \
  REVISION_TAG \
  GIT_URL \
  GIT_BRANCH \
  SOURCE_PATH \
  DOCKER_ROOT \
  HOSTNAME=${HOSTNAME:-$(hostname)} \
  ENV=${ENV:-dev} \
  COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME:-"{{name}}"} \
  COMPOSE_HTTP_TIMEOUT=${COMPOSE_HTTP_TIMEOUT:-300} \
  COMPOSE_FILE="$DOCKER_ROOT/docker-compose.${ENV%.*}.yml" \
  \ # Wait # seconds before kill -9 stopping container
  STOP_WAIT_TIMEOUT=${STOP_WAIT_TIMEOUT:-10} \
  \ # If 1 names will be project.container.0 also when scale not set
  CONTAINER_SCALE_INDEX=${CONTAINER_SCALE_INDEX:-1} \
  \ # If you use this be sure to run yoda build --push by self before deploying
  REGISTRY_URL=${REGISTRY_URL:-''}
